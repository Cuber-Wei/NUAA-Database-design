# 百万级数据压力测试使用说明

## 📖 概述

本压力测试套件专为原神抽卡系统设计，用于评测系统在百万量级数据下的响应性能。包含数据库压力测试、API压力测试和简单性能测试三种模式。

## 🎯 测试目标

- **数据库性能**: 测试在百万级数据量下的查询响应时间
- **API接口性能**: 测试Web接口在高并发下的处理能力  
- **系统稳定性**: 验证系统在高负载下的稳定性
- **性能瓶颈识别**: 发现系统性能瓶颈并提供优化建议

## 📂 文件结构

```
├── stress_test.py           # 数据库压力测试脚本
├── api_stress_test.py       # API压力测试脚本  
├── test_performance.py      # 简单性能测试脚本
├── run_stress_test.py       # 统一运行入口
└── 压力测试使用说明.md      # 本文档
```

## 🔧 环境准备

### 系统要求

- **操作系统**: Windows/Linux/macOS
- **Python版本**: 3.8+
- **内存**: 建议8GB以上
- **硬盘空间**: 建议20GB以上可用空间

### 依赖安装

```bash
# 安装必要的Python模块
pip install pymysql requests psutil

# 或者使用项目要求文件（如果有）
pip install -r requirements.txt
```

### 数据库配置

确保MySQL服务正在运行，并且：

1. 数据库 `wishes_db` 已创建
2. 基础数据表已初始化（运行 `db.sql`）
3. 角色和武器数据已导入
4. 数据库连接参数正确配置

## 🚀 快速开始

### 方式一：交互式运行

```bash
python run_stress_test.py --interactive
```

这将启动交互式菜单，您可以按提示选择测试模式和参数。

### 方式二：命令行运行

```bash
# 数据库压力测试 - 中等规模
python run_stress_test.py --mode db --scale normal

# API压力测试 - 中等强度
python run_stress_test.py --mode api --concurrency normal

# 简单性能测试
python run_stress_test.py --mode simple

# 环境检查
python run_stress_test.py --mode check
```

### 方式三：直接运行单个脚本

```bash
# 数据库压力测试
python stress_test.py

# API压力测试
python api_stress_test.py

# 简单性能测试
python test_performance.py
```

## 📊 测试模式详解

### 1. 数据库压力测试 (`stress_test.py`)

**功能**: 生成大量测试数据并执行复杂查询，评测数据库性能

**测试规模**:
- **小规模**: 1万用户，20万抽卡记录
- **中规模**: 10万用户，500万抽卡记录  
- **大规模**: 100万用户，1亿抽卡记录

**测试内容**:
- 批量数据生成
- 用户统计查询
- 时间范围统计
- 热门角色武器统计
- 分页查询性能

**配置参数**:
```python
TEST_CONFIG = {
    "test_params": {
        "user_count": 100000,          # 测试用户数量
        "wish_records_per_user": 50,   # 每个用户的抽卡记录数
        "batch_size": 1000,           # 批量操作大小
    }
}
```

### 2. API压力测试 (`api_stress_test.py`)

**功能**: 模拟高并发用户访问Web接口，测试系统处理能力

**测试强度**:
- **轻度**: 20并发用户，持续1分钟
- **中度**: 50并发用户，持续2分钟
- **重度**: 100并发用户，持续5分钟

**测试接口**:
- 用户注册 (`/register`)
- 用户登录 (`/login`)
- 抽卡操作 (`/wish`)
- 查看历史 (`/history`)
- 用户仪表板 (`/dashboard`)

**配置参数**:
```python
API_TEST_CONFIG = {
    "test_params": {
        "concurrent_users": 50,        # 并发用户数
        "test_duration": 120,          # 测试持续时间(秒)
        "ramp_up_time": 30,           # 渐进加压时间(秒)
        "request_interval": 0.1,       # 请求间隔(秒)
    }
}
```

### 3. 简单性能测试 (`test_performance.py`)

**功能**: 快速验证系统核心查询性能，适合日常性能监控

**测试内容**:
- 用户统计查询
- 最近记录查询  
- 分页查询
- 按类型筛选查询
- 索引使用情况分析

## 📈 测试报告解读

### 数据库测试报告

```
📊 压力测试报告
================================================================================

🎯 测试概览:
   总操作数: 20
   成功操作: 20 (100.0%)
   失败操作: 0 (0.0%)

📈 详细测试结果:
操作类型              成功率    平均响应时间  P95响应时间   吞吐量    
--------------------------------------------------------------------------------
大数据量用户统计      100.0%   45.23ms      52.18ms      22.1ops/s
按时间范围统计抽卡    100.0%   123.45ms     145.67ms     8.1ops/s
热门角色武器统计      100.0%   89.12ms      98.45ms      11.2ops/s
用户抽卡历史分页查询  100.0%   12.34ms      15.67ms      81.0ops/s

🎯 性能评估:
   🟢 快速操作 (<100ms): 3个
   🟡 中等操作 (100-500ms): 1个
   🔴 慢操作 (>=500ms): 0个
```

### API测试报告

```
📊 API压力测试报告
================================================================================

🎯 总体统计:
   总请求数: 1,234
   成功请求: 1,198 (97.1%)
   失败请求: 36 (2.9%)

📈 详细性能指标:
操作        请求数    成功率    平均响应    P95响应     P99响应     RPS     
--------------------------------------------------------------------------------
login       370      98.1%     45.2ms     78.9ms     125.4ms    15.8
wish        493      96.3%     123.4ms    245.6ms    456.7ms    12.3
history     247      98.8%     34.5ms     67.8ms     89.2ms     18.9
dashboard   124      99.2%     23.1ms     45.6ms     78.9ms     21.2
```

### 关键指标说明

- **响应时间**: 单次操作的处理时间
- **P95/P99响应时间**: 95%/99%的请求在此时间内完成
- **吞吐量(RPS)**: 每秒处理的请求数
- **成功率**: 成功处理的请求比例

## ⚠️ 注意事项

### 数据安全

1. **备份数据**: 测试前备份重要数据
2. **测试环境**: 建议在测试环境而非生产环境运行
3. **数据清理**: 测试完成后清理生成的测试数据

### 性能影响

1. **系统资源**: 大规模测试会消耗大量CPU、内存和磁盘IO
2. **网络带宽**: API测试会产生大量网络请求
3. **数据库负载**: 可能影响数据库的正常使用

### 测试限制

1. **硬件限制**: 测试规模受硬件配置限制
2. **时间成本**: 大规模测试可能需要较长时间
3. **网络环境**: API测试依赖网络连接质量

## 🔧 配置调优

### 数据库配置优化

```sql
-- MySQL配置建议
SET GLOBAL innodb_buffer_pool_size = 4G;
SET GLOBAL max_connections = 1000;
SET GLOBAL query_cache_size = 256M;
```

### 应用服务器配置

```python
# Flask配置建议
app.config['SQLALCHEMY_POOL_SIZE'] = 20
app.config['SQLALCHEMY_MAX_OVERFLOW'] = 0
app.config['SQLALCHEMY_POOL_TIMEOUT'] = 30
```

### 系统资源监控

测试期间建议监控：
- CPU使用率
- 内存使用率
- 磁盘IO
- 网络IO
- 数据库连接数

## 🐛 常见问题

### Q1: 数据库连接失败
**A**: 检查数据库服务是否启动，连接参数是否正确

### Q2: 内存不足错误
**A**: 减少测试规模或增加系统内存

### Q3: API测试无法连接服务器
**A**: 确保Flask应用正在运行，端口5001可访问

### Q4: 测试速度很慢
**A**: 检查硬盘性能，考虑使用SSD；优化数据库配置

### Q5: 生成的数据过多
**A**: 调整配置参数，使用较小的测试规模

## 📝 测试最佳实践

### 测试前准备

1. **环境隔离**: 使用独立的测试环境
2. **数据备份**: 备份重要数据  
3. **监控准备**: 准备系统监控工具
4. **时间规划**: 预留足够的测试时间

### 测试执行

1. **逐步增压**: 从小规模开始，逐步增加压力
2. **持续监控**: 实时监控系统资源使用情况
3. **记录问题**: 及时记录发现的性能问题
4. **多次测试**: 多次运行以确保结果可靠

### 测试后分析

1. **结果分析**: 仔细分析测试报告
2. **问题定位**: 定位性能瓶颈
3. **优化建议**: 制定具体的优化方案
4. **报告整理**: 整理完整的测试报告

## 📊 性能基准

### 参考性能指标

| 操作类型 | 优秀 | 良好 | 一般 | 需优化 |
|---------|------|------|------|--------|
| 简单查询 | <10ms | 10-50ms | 50-100ms | >100ms |
| 复杂查询 | <50ms | 50-200ms | 200-500ms | >500ms |
| API响应 | <100ms | 100-300ms | 300-1000ms | >1000ms |
| 并发处理 | >100 RPS | 50-100 RPS | 20-50 RPS | <20 RPS |

### 系统容量规划

| 用户规模 | 数据量 | 建议配置 |
|---------|--------|----------|
| 1万用户 | 100万记录 | 2核4GB |
| 10万用户 | 1000万记录 | 4核8GB |
| 100万用户 | 1亿记录 | 8核16GB |

## 🎉 总结

本压力测试套件提供了全面的性能评测功能，帮助您：

1. **评估系统性能**: 全面了解系统在高负载下的表现
2. **发现性能瓶颈**: 快速定位系统的性能短板
3. **验证优化效果**: 量化优化措施的效果
4. **制定容量规划**: 为系统扩容提供数据支持

通过合理使用这些测试工具，您可以确保系统在实际部署中具备良好的性能表现。

---

**联系信息**: 如有问题，请参考项目文档或联系开发团队。 



📈 详细测试结果:
操作类型                 成功率      平均响应时间       P95响应时间      吞吐量
--------------------------------------------------------------------------------
大数据量用户统计             100.0   % 1063.82     ms 3215.91     ms 0.94      ops/s
按时间范围统计抽卡            100.0   % 5108.89     ms 10640.71    ms 0.20      ops/s
热门角色武器统计             100.0   % 39998.22    ms 48477.09    ms 0.03      ops/s
用户抽卡历史分页查询           100.0   % 0.72        ms 3.78        ms 1398.05   ops/s

📈 详细性能指标:
操作           请求数      成功率      平均响应       P95响应      P99响应      RPS
--------------------------------------------------------------------------------
login        456      100.0   % 2053.4    ms 2075.6    ms 2084.7    ms 3.9
wish         615      100.0   % 4105.8    ms 4136.8    ms 4148.0    ms 5.2
history      290      100.0   % 4104.2    ms 4134.5    ms 4147.5    ms 2.5
dashboard    146      100.0   % 4101.4    ms 4128.8    ms 4147.8    ms 1.3