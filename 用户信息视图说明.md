# 用户信息视图说明

## 概述

`user_info_view` 是一个综合性的数据库视图，用于展示用户在抽卡系统中的完整信息。该视图整合了用户基本信息、抽卡统计数据和保底状态，提供了一个便捷的数据查询接口。

## 视图结构

### 字段说明

| 字段名 | 数据类型 | 描述 |
|--------|----------|------|
| 用户ID | bigint | 用户唯一标识符 |
| 用户名 | varchar(20) | 用户显示名称 |
| 角色4星保底计数 | int | 角色卡池4星保底当前计数 |
| 武器4星保底计数 | int | 武器卡池4星保底当前计数 |
| 角色5星保底计数 | int | 角色卡池5星保底当前计数 |
| 武器5星保底计数 | int | 武器卡池5星保底当前计数 |
| 角色4星保底剩余 | int | 角色卡池4星保底剩余次数 (10-当前计数) |
| 武器4星保底剩余 | int | 武器卡池4星保底剩余次数 (10-当前计数) |
| 角色5星保底剩余 | int | 角色卡池5星保底剩余次数 (80-当前计数) |
| 武器5星保底剩余 | int | 武器卡池5星保底剩余次数 (80-当前计数) |
| 总抽卡次数 | int | 用户总抽卡次数 |
| 角色抽卡次数 | int | 角色卡池抽卡次数 |
| 武器抽卡次数 | int | 武器卡池抽卡次数 |
| 五星角色数量 | int | 获得的5星角色数量 |
| 五星武器数量 | int | 获得的5星武器数量 |
| 最后抽卡时间 | datetime | 最后一次抽卡的时间 |

## 主要功能

### 1. 用户基本信息展示
- 显示用户ID和用户名
- 便于用户身份识别和管理

### 2. 保底状态监控
- **实时计算保底剩余次数**
  - 4星保底：每10次必出一个4星
  - 5星保底：每80次必出一个5星
- **支持角色和武器两个卡池**
- **便于用户了解当前保底进度**

### 3. 抽卡统计分析
- 总抽卡次数统计
- 分卡池抽卡次数统计
- 5星物品获取统计
- 最后活跃时间追踪

### 4. 数据整合
- 自动关联用户表、抽卡记录表、角色表、武器表
- 使用LEFT JOIN确保即使没有抽卡记录的用户也会显示
- 使用COALESCE函数处理NULL值

## 使用场景

### 1. 用户个人中心
```sql
-- 查看指定用户的完整信息
SELECT * FROM user_info_view WHERE 用户名 = '张三';
```

### 2. 排行榜功能
```sql
-- 抽卡次数排行榜
SELECT 用户名, 总抽卡次数 
FROM user_info_view 
ORDER BY 总抽卡次数 DESC 
LIMIT 10;
```

### 3. 运营数据分析
```sql
-- 用户活跃度分析
SELECT 
    COUNT(*) as 总用户数,
    COUNT(CASE WHEN 总抽卡次数 > 0 THEN 1 END) as 活跃用户数,
    AVG(总抽卡次数) as 平均抽卡次数
FROM user_info_view;
```

### 4. 保底提醒功能
```sql
-- 查找接近保底的用户
SELECT 用户名, 角色5星保底剩余, 武器5星保底剩余
FROM user_info_view 
WHERE 角色5星保底剩余 <= 10 OR 武器5星保底剩余 <= 10;
```

## 性能优化建议

### 1. 索引优化
确保以下字段有适当的索引：
- `users.Uno` (主键)
- `users.Uname` (已有索引)
- `wishes.Wuser` (已有索引)
- `wishes.Wtime` (建议添加)

### 2. 查询优化
- 避免使用 `SELECT *`，只选择需要的字段
- 在WHERE条件中使用索引字段
- 对于频繁查询，考虑添加物化视图

### 3. 缓存策略
- 对于变化不频繁的统计数据，可以考虑缓存
- 实时性要求不高的场景可以使用定时更新的汇总表

## 维护说明

### 1. 数据一致性
- 视图数据依赖于基础表，确保基础表数据的完整性
- 定期检查视图查询结果的准确性

### 2. 性能监控
- 监控视图查询的执行时间
- 根据使用情况调整查询优化策略

### 3. 扩展性
- 可以根据业务需求添加更多计算字段
- 支持创建基于此视图的其他汇总视图

## 注意事项

1. **数据实时性**：视图数据是实时计算的，性能开销相对较大
2. **NULL值处理**：使用COALESCE函数确保统计字段不为NULL
3. **保底计算逻辑**：基于当前系统的保底机制（4星10次，5星80次）
4. **JOIN性能**：涉及多表JOIN，建议在大数据量场景下优化查询条件

## 示例查询

详细的示例查询请参考 `user_info_view_examples.sql` 文件，包含了各种常见的使用场景和查询模式。 